#!/bin/bash

set -e

TARGET_DIR=$(dirname $0)
RM=true

if [[ $1 == "keep"  ]]
then
	RM=false
	shift
fi

if ${RM}
then
	rm -rf ${TARGET_DIR}/build
fi
mkdir -p ${TARGET_DIR}/build
cd ${TARGET_DIR}/build

../configure


case $1 in

	"dbg")
		shift
		make -j9;
		bash -c "gdb ./lunkwill -ex 'set follow-fork-mode child' $@"
	;;
	"mem")
		shift
		make -j9;
		bash -c "valgrind --leak-check=full --track-origins=yes --show-reachable=yes --show-possibly-lost=yes --trace-children=yes --time-stamp=yes ./lunkwill $@"
	;;
	"run")
		shift
		make -j9;
		clear;
		bash -c "./lunkwill $@"
	;;
	"doc")
		cd ..
		mkdir -p docs

		(cat scripts/doxyfile; \
		 echo "EXCLUDE = 04-plugins" )| doxygen -

		for i in $(ls ./04-plugins/);
		do
			cat scripts/doxyfile | sed -e \
			"s#OUTPUT_DIRECTORY       = docs/lunkwill#OUTPUT_DIRECTORY       = docs/$i#" \
			| sed -e \
				"s#INPUT                  = .#INPUT                  = ./04-plugins/$i#" \
			| doxygen -
		done

		rm -f ./docs/index.html
		for i in $(ls ./docs/);
		do
			echo "<a href='./$i/html/index.html'>$i</a><br>">>./docs/index.html
		done
	;;

	"clang")
		CC=clang make -j9
		bash
	;;
	
	"gcc")
		make -j9;
		bash
	;;
	
	*)
		echo $@
		bash
esac

if ${RM}
then
	rm -rf ${TARGET_DIR}/build
fi

